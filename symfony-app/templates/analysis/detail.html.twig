{% extends 'base.html.twig' %}

{% block title %}D√©tail Analyse - MAESTRO{% endblock %}

{% block body %}
{# Header #}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ path('app_home') }}">Accueil</a></li>
                <li class="breadcrumb-item"><a href="{{ path('app_analyses_list') }}">Analyses</a></li>
                <li class="breadcrumb-item active">D√©tail</li>
            </ol>
        </nav>
        <h1 class="display-6 fw-bold text-primary mb-3">
            <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                Analyse D√©taill√©e
            </span>
        </h1>
    </div>
</div>

{# Main Analysis Card #}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h4 class="mb-0 text-white">üìã Requ√™te d'Analyse</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="text-dark">{{ analysis.request_text }}</h5>
                        <p class="text-muted">
                            <small>Cr√©√© le {{ analysis.created_at|date('d/m/Y √† H:i') }}</small>
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="mb-2">
                            <strong>Type:</strong>
                            <span class="badge bg-{{ analysis.analysis_type == 'FEATURE' ? 'primary' : (analysis.analysis_type == 'BUG' ? 'danger' : 'info') }}">
                                {{ analysis.analysis_type|default('N/A') }}
                            </span>
                        </div>
                        <div class="mb-2">
                            <strong>Complexit√©:</strong>
                            <span class="badge bg-{{ analysis.complexity == 'XS' ? 'success' : (analysis.complexity == 'S' ? 'info' : (analysis.complexity == 'M' ? 'warning' : 'danger')) }}">
                                {{ analysis.complexity|default('N/A') }}
                            </span>
                        </div>
                        <div class="mb-2">
                            <strong>Priorit√©:</strong>
                            <span class="badge bg-{{ analysis.priority == 'CRITICAL' ? 'danger' : (analysis.priority == 'HIGH' ? 'warning' : 'info') }}">
                                {{ analysis.priority|default('N/A') }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# Metrics Row #}
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <h6 class="text-muted">Confiance IA</h6>
                <h2 class="text-{{ analysis.confidence >= 0.8 ? 'success' : (analysis.confidence >= 0.6 ? 'info' : 'warning') }}">
                    {{ (analysis.confidence * 100)|round }}%
                </h2>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-{{ analysis.confidence >= 0.8 ? 'success' : (analysis.confidence >= 0.6 ? 'info' : 'warning') }}"
                         style="width: {{ (analysis.confidence * 100)|round }}%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <h6 class="text-muted">Heures Estim√©es</h6>
                <h2 class="text-dark">{{ analysis.estimated_hours|default('N/A') }}h</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <h6 class="text-muted">Agents N√©cessaires</h6>
                <h2 class="text-dark">{{ analysis.agents_needed|length }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <h6 class="text-muted">Parall√©lisation</h6>
                <h2 class="text-dark">{{ analysis.parallel_possible ? '‚úì Oui' : '‚úó Non' }}</h2>
            </div>
        </div>
    </div>
</div>

{# Agents Needed #}
{% if analysis.agents_needed is not empty %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0 text-dark">ü§ñ Agents IA N√©cessaires</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {% for agent in analysis.agents_needed %}
                    <div class="col-md-4">
                        <div class="border rounded p-3 h-100 bg-light">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-primary me-2">{{ loop.index }}</span>
                                <strong>{{ agent }}</strong>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{# Next Steps and Risks #}
<div class="row mb-4">
    {% if analysis.next_steps is not empty %}
    <div class="col-md-{{ analysis.risks is not empty ? '6' : '12' }}">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0 text-dark">üìù Prochaines √âtapes</h5>
            </div>
            <div class="card-body">
                <ol class="list-group list-group-numbered">
                    {% for step in analysis.next_steps %}
                    <li class="list-group-item border-0 px-0">{{ step }}</li>
                    {% endfor %}
                </ol>
            </div>
        </div>
    </div>
    {% endif %}

    {% if analysis.risks is not empty %}
    <div class="col-md-{{ analysis.next_steps is not empty ? '6' : '12' }}">
        <div class="card border-0 shadow-sm border-warning h-100">
            <div class="card-header bg-warning bg-opacity-10 border-0 py-3">
                <h5 class="mb-0 text-dark">‚ö†Ô∏è Risques Identifi√©s</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% for risk in analysis.risks %}
                    <li class="list-group-item border-0 px-0">
                        <span class="badge bg-warning text-dark me-2">!</span>
                        {{ risk }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{# Section Cadrage supprim√©e - voir MIGRATION_COMPLETE.md #}

{# User Stories Section #}
{% if userStories is not empty %}
{% set total_points = 0 %}
{% for s in userStories %}{% set total_points = total_points + (s.story_points|default(0)) %}{% endfor %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0 text-white"><i class="bi bi-journal-text"></i> User Stories de cette analyse</h4>
                    <div class="d-flex align-items-center gap-3">
                        <span class="badge bg-light text-dark" style="font-size: 1rem;">
                            {{ userStories|length }} stories ‚Ä¢ {{ total_points }} pts
                        </span>
                        {% if project %}
                        <a href="{{ path('app_project_user_stories', {projectId: project.id}) }}" class="btn btn-sm btn-light">
                            <i class="bi bi-collection"></i> Voir toutes les US du projet
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card-body">
                {# Summary Metrics #}
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded bg-light">
                            <h6 class="text-muted mb-2">Story Points Total</h6>
                            <h2 class="text-primary mb-0">{{ total_points }}</h2>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded bg-light">
                            <h6 class="text-muted mb-2">User Stories</h6>
                            <h2 class="text-info mb-0">{{ userStories|length }}</h2>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded bg-light">
                            <h6 class="text-muted mb-2">MUST Have</h6>
                            <h2 class="text-danger mb-0">
                                {% set must_count = 0 %}
                                {% for story in userStories %}
                                    {% if story.priority == 'MUST' %}
                                        {% set must_count = must_count + 1 %}
                                    {% endif %}
                                {% endfor %}
                                {{ must_count }}
                            </h2>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded bg-light">
                            <h6 class="text-muted mb-2">Sprints Estim√©s</h6>
                            <h2 class="text-warning mb-0">
                                {{ (total_points / 20)|round(0, 'ceil') }}
                            </h2>
                        </div>
                    </div>
                </div>

                {# User Stories Cards #}
                <h5 class="mb-3 text-dark"><i class="bi bi-list-ul"></i> Stories D√©taill√©es</h5>
                <div class="row g-3">
                    {% for story in userStories %}
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 border-start border-4 {% if story.priority == 'MUST' %}border-danger{% elseif story.priority == 'SHOULD' %}border-warning{% elseif story.priority == 'COULD' %}border-info{% else %}border-secondary{% endif %} shadow-sm">
                            <div class="card-body d-flex flex-column">
                                {# Header #}
                                <div class="mb-3">
                                    <div class="d-flex align-items-center flex-wrap gap-1 mb-2">
                                        <span class="badge bg-secondary">{{ story.story_id }}</span>
                                        <span class="badge {% if story.priority == 'MUST' %}bg-danger{% elseif story.priority == 'SHOULD' %}bg-warning{% elseif story.priority == 'COULD' %}bg-info{% else %}bg-secondary{% endif %}">
                                            {{ story.priority }}
                                        </span>
                                        <span class="badge bg-primary">{{ story.story_points }} pts</span>
                                    </div>
                                    <h6 class="card-title mb-0">{{ story.title }}</h6>
                                </div>

                                {# User Story Format - Collapsible #}
                                <div class="mb-3">
                                    <details>
                                        <summary style="cursor: pointer;" class="text-primary mb-2">
                                            <small><i class="bi bi-info-circle"></i> Voir le d√©tail</small>
                                        </summary>
                                        <div class="alert alert-light mb-0 mt-2">
                                            <p class="mb-1"><small><strong>En tant que</strong> {{ story.as_a }}</small></p>
                                            <p class="mb-1"><small><strong>Je veux</strong> {{ story.i_want }}</small></p>
                                            <p class="mb-0"><small><strong>Afin de</strong> {{ story.so_that }}</small></p>
                                        </div>
                                    </details>
                                </div>

                                {# Acceptance Criteria - Collapsible #}
                                {% if story.acceptance_criteria is defined and story.acceptance_criteria is not empty %}
                                <div class="mb-3">
                                    <details>
                                        <summary style="cursor: pointer;" class="text-success mb-2">
                                            <small><i class="bi bi-check-circle"></i> Crit√®res d'acceptance ({{ story.acceptance_criteria|length }})</small>
                                        </summary>
                                        <ul class="list-group list-group-flush mt-2">
                                            {% for criteria in story.acceptance_criteria %}
                                            <li class="list-group-item px-0 py-1">
                                                <small>{{ criteria }}</small>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                    </details>
                                </div>
                                {% endif %}

                                {# Test Scenarios - Expanded #}
                                {% if story.test_scenarios is defined and story.test_scenarios is not empty %}
                                <div class="mb-3">
                                    {% if story.test_scenarios is iterable %}
                                        {# New format: array of scenarios #}
                                        <details>
                                            <summary style="cursor: pointer;" class="text-info mb-2">
                                                <small><i class="bi bi-clipboard-check"></i> Sc√©narios de test ({{ story.test_scenarios|length }})</small>
                                            </summary>
                                            <ul class="list-group list-group-flush mt-2">
                                                {% for scenario in story.test_scenarios %}
                                                <li class="list-group-item px-0 py-1">
                                                    <small>{{ scenario }}</small>
                                                </li>
                                                {% endfor %}
                                            </ul>
                                        </details>
                                    {% else %}
                                        {# Old format: just a number #}
                                        <small class="text-info">
                                            <i class="bi bi-clipboard-check"></i> {{ story.test_scenarios }} sc√©narios de test (ancien format)
                                        </small>
                                    {% endif %}
                                </div>
                                {% endif %}

                                {# Footer - pushed to bottom #}
                                <div class="mt-auto pt-2 border-top">
                                    {% if story.dependencies is defined and story.dependencies is not empty %}
                                    <div class="mb-2">
                                        <small class="text-muted">
                                            <i class="bi bi-link-45deg"></i> <strong>D√©pendances:</strong>
                                            {% for dep in story.dependencies %}
                                                <span class="badge bg-light text-dark">{{ dep }}</span>
                                            {% endfor %}
                                        </small>
                                    </div>
                                    {% endif %}

                                    {# Technical Notes #}
                                    {% if story.technical_notes is defined and story.technical_notes %}
                                    <details class="text-muted">
                                        <summary style="cursor: pointer;"><small><i class="bi bi-code-square"></i> Notes techniques</small></summary>
                                        <div class="mt-2 p-2 bg-light rounded">
                                            <small>{{ story.technical_notes }}</small>
                                        </div>
                                    </details>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{# Orchestration Section #}
{% if request and request.status == 'COMPLETED' and userStories is empty %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm border-success">
            <div class="card-header bg-success bg-opacity-10 border-0 py-3">
                <h5 class="mb-0 text-dark">üöÄ Orchestration des Agents</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <p class="mb-2"><strong>Analyse termin√©e !</strong> Vous pouvez maintenant lancer l'orchestration des agents IA.</p>
                        <p class="text-muted mb-0">
                            <small>
                                Agents qui seront lanc√©s :
                                {% for agent in analysis.agents_needed %}
                                    <span class="badge bg-primary">{{ agent }}</span>
                                {% endfor %}
                                {% if analysis.parallel_possible %}
                                    <span class="badge bg-info ms-2">‚ö° Ex√©cution parall√®le</span>
                                {% else %}
                                    <span class="badge bg-warning ms-2">‚è±Ô∏è Ex√©cution s√©quentielle</span>
                                {% endif %}
                            </small>
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#orchestrateModal">
                            <i class="bi bi-play-circle"></i> Lancer l'Orchestration
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{# Partial Orchestration - When some agents already ran #}
{% if request and request.status == 'COMPLETED' and userStories is not empty %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm border-primary">
            <div class="card-header bg-primary bg-opacity-10 border-0 py-3">
                <h5 class="mb-0 text-dark">üîÑ Continuer l'Orchestration</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <p class="mb-2"><strong>Agents d√©j√† ex√©cut√©s :</strong></p>
                        <p class="mb-2">
                            {% if userStories is not empty %}<span class="badge bg-success me-1">‚úì USER STORIES</span>{% endif %}
                        </p>
                        <p class="text-muted mb-0">
                            <small>Vous pouvez relancer l'orchestration compl√®te pour ex√©cuter les agents restants.</small>
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#orchestrateModal">
                            <i class="bi bi-play-circle"></i> Relancer l'Orchestration
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if request and request.status == 'ORCHESTRATING' %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info d-flex align-items-center" role="alert">
            <div class="spinner-border spinner-border-sm me-3" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <div>
                <strong>Orchestration en cours...</strong> Les agents sont en train d'√™tre d√©ploy√©s.
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if request and request.status == 'AGENTS_RUNNING' %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning d-flex align-items-center" role="alert">
            <div class="spinner-border spinner-border-sm me-3" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <div>
                <strong>Agents en cours d'ex√©cution...</strong> Les r√©sultats appara√Ætront bient√¥t.
            </div>
        </div>
    </div>
</div>
{% endif %}

{# Action Buttons #}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between">
            <a href="{{ path('app_analyses_list') }}" class="btn btn-outline-secondary">
                ‚Üê Retour √† la liste
            </a>
            <div>
                <button class="btn btn-outline-primary" onclick="window.print()">
                    üñ®Ô∏è Imprimer
                </button>
                <button class="btn btn-primary" onclick="exportJSON()">
                    üíæ Exporter JSON
                </button>
            </div>
        </div>
    </div>
</div>

{# Modal de confirmation pour l'orchestration #}
<div class="modal fade" id="orchestrateModal" tabindex="-1" aria-labelledby="orchestrateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success bg-opacity-10">
                <h5 class="modal-title" id="orchestrateModalLabel">
                    üöÄ Confirmer l'orchestration
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">√ätes-vous s√ªr de vouloir lancer l'orchestration des agents IA ?</p>
                <div class="alert alert-info mb-0">
                    <strong>Agents qui seront lanc√©s :</strong>
                    <ul class="mb-0 mt-2">
                        {% for agent in analysis.agents_needed %}
                        <li><span class="badge bg-primary">{{ agent }}</span></li>
                        {% endfor %}
                    </ul>
                    {% if analysis.parallel_possible %}
                    <p class="mb-0 mt-2"><small>‚ö° Les agents seront ex√©cut√©s en parall√®le</small></p>
                    {% else %}
                    <p class="mb-0 mt-2"><small>‚è±Ô∏è Les agents seront ex√©cut√©s s√©quentiellement</small></p>
                    {% endif %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <form method="post" action="{{ path('app_analysis_orchestrate', {id: analysis.id}) }}" class="d-inline">
                    <input type="hidden" name="_token" value="{{ csrf_token('orchestrate_analysis_' ~ analysis.id) }}">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-play-circle"></i> Confirmer et lancer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        function exportJSON() {
            const data = {
                analysis: {{ analysis|json_encode|raw }},
                cadrage: {{ cadrage|default({})|json_encode|raw }},
                userStories: {{ userStories|default({})|json_encode|raw }}
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'analysis_{{ analysis.id }}.json';
            link.click();
        }

        // Toggle chevron icon on cadrage collapse
        const cadrageCollapse = document.getElementById('cadrageCollapse');
        const cadrageChevron = document.getElementById('cadrageChevron');

        if (cadrageCollapse && cadrageChevron) {
            cadrageCollapse.addEventListener('show.bs.collapse', function () {
                cadrageChevron.classList.remove('bi-chevron-right');
                cadrageChevron.classList.add('bi-chevron-down');
            });

            cadrageCollapse.addEventListener('hide.bs.collapse', function () {
                cadrageChevron.classList.remove('bi-chevron-down');
                cadrageChevron.classList.add('bi-chevron-right');
            });
        }
    </script>
{% endblock %}
