{% extends 'base.html.twig' %}

{% block title %}CI Builds - {{ story.title }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .build-card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .build-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .build-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .build-header.success { background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; }
        .build-header.failed { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; }
        .build-header.running { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
        .build-header.pending { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; }

        .build-stats {
            display: flex;
            gap: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
        }

        .story-summary {
            background: #f8f9fa;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            margin-bottom: 2rem;
            border-radius: 4px;
        }
    </style>
{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    {# Breadcrumb #}
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ path('app_project_dashboard', {slug: project.slug}) }}">
                    <i class="bi bi-house"></i> {{ project.name }}
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ path('app_analysis_detail', {id: analysisId}) }}">
                    <i class="bi bi-bar-chart"></i> Analyse
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ path('app_user_story_code', {analysisId: analysisId, storyId: story.id}) }}">
                    <i class="bi bi-code-slash"></i> Code
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ path('app_user_story_tests', {analysisId: analysisId, storyId: story.id}) }}">
                    <i class="bi bi-clipboard-check"></i> Tests
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">CI Builds</li>
        </ol>
    </nav>

    {# User Story Summary #}
    <div class="story-summary">
        <h5 class="mb-3">
            <i class="bi bi-card-text text-primary"></i> {{ story.title }}
        </h5>
        <div class="row">
            <div class="col-md-8">
                <p class="mb-2"><strong>En tant que:</strong> {{ story.as_a }}</p>
                <p class="mb-0"><strong>Je veux:</strong> {{ story.i_want }}</p>
            </div>
            <div class="col-md-4 text-end">
                {% if gitBranch %}
                    <small class="text-muted d-block">Branche:</small>
                    <code>{{ gitBranch.branch_name }}</code>
                    {% if gitBranch.pr_url %}
                        <br>
                        <a href="{{ gitBranch.pr_url }}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">
                            <i class="bi bi-git"></i> PR #{{ gitBranch.pr_number }}
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <h4 class="mb-3">
        <i class="bi bi-hammer"></i> Historique des Builds
    </h4>

    {% if builds is empty %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            Aucun build CI/CD trouvé pour cette User Story.
            Les builds seront créés automatiquement lors des commits sur la branche Git.
        </div>
    {% else %}
        {% for build in builds %}
        <div class="build-card">
            <div class="build-header {{ build.status|lower }}">
                <div>
                    <h6 class="mb-1">
                        <i class="bi {% if build.status == 'SUCCESS' %}bi-check-circle{% elseif build.status == 'FAILED' %}bi-x-circle{% elseif build.status == 'RUNNING' %}bi-arrow-clockwise{% else %}bi-clock{% endif %}"></i>
                        Build #{{ build.build_number }}
                    </h6>
                    <small class="opacity-75">
                        {{ build.started_at|date('d/m/Y H:i') }}
                        {% if build.finished_at %}
                            - Terminé à {{ build.finished_at|date('H:i') }}
                        {% endif %}
                    </small>
                </div>
                <div>
                    <span class="badge bg-white text-dark">{{ build.status }}</span>
                </div>
            </div>

            <div class="build-stats">
                <div class="stat">
                    <div class="stat-value text-{% if build.status == 'SUCCESS' %}success{% elseif build.status == 'FAILED' %}danger{% else %}secondary{% endif %}">
                        {{ build.duration ?: '...' }}
                    </div>
                    <div class="stat-label">Durée (s)</div>
                </div>

                {% if build.test_results %}
                <div class="stat">
                    <div class="stat-value text-success">{{ build.test_results.passed|default(0) }}</div>
                    <div class="stat-label">Tests réussis</div>
                </div>

                <div class="stat">
                    <div class="stat-value text-danger">{{ build.test_results.failed|default(0) }}</div>
                    <div class="stat-label">Tests échoués</div>
                </div>

                <div class="stat">
                    <div class="stat-value text-info">{{ build.coverage|default(0) }}%</div>
                    <div class="stat-label">Coverage</div>
                </div>
                {% endif %}

                <div class="ms-auto">
                    <a href="{{ path('app_build_detail', {buildId: build.id}) }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye"></i> Détails
                    </a>
                </div>
            </div>

            {% if build.status == 'FAILED' and build.test_results and build.test_results.failures %}
            <div class="alert alert-danger mb-0 rounded-0">
                <strong><i class="bi bi-exclamation-triangle"></i> Tests en échec:</strong>
                <ul class="mb-0 mt-2">
                    {% for failure in build.test_results.failures|slice(0, 3) %}
                    <li><code>{{ failure.test }}</code> - {{ failure.message }}</li>
                    {% endfor %}
                    {% if build.test_results.failures|length > 3 %}
                    <li><em>et {{ build.test_results.failures|length - 3 }} autre(s)...</em></li>
                    {% endif %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    {% endif %}

    {# Back Button #}
    <div class="text-center mt-4">
        <a href="{{ path('app_user_story_tests', {analysisId: analysisId, storyId: story.id}) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Retour aux tests
        </a>
    </div>
</div>
{% endblock %}
