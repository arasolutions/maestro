{
  "name": "MAESTRO - Agent Orchestrator",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "orchestrate",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [-960, 240],
      "id": "webhook-orchestrate",
      "name": "Start Orchestration",
      "webhookId": "orchestrate-maestro"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "field1",
              "name": "analysis_id",
              "value": "={{ $json.body.analysis_id }}",
              "type": "string"
            },
            {
              "id": "field2",
              "name": "request_id",
              "value": "={{ $json.body.request_id }}",
              "type": "string"
            },
            {
              "id": "field3",
              "name": "project_id",
              "value": "={{ $json.body.project_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-760, 240],
      "id": "keep-input-data",
      "name": "Keep Input Data"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT a.*, r.status as request_status\nFROM maestro.analyses a\nJOIN maestro.requests r ON a.request_id = r.id\nWHERE a.id = $1::uuid",
        "options": {
          "queryReplacement": "={{ [$('Keep Input Data').item.json.analysis_id] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [-560, 240],
      "id": "fetch-analysis",
      "name": "Fetch Analysis from DB",
      "credentials": {
        "postgres": {
          "id": "TxOzBdadKcgasYEn",
          "name": "MAESTRO DB"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE maestro.requests SET status = 'ORCHESTRATING', updated_at = NOW() WHERE id = $1::uuid",
        "options": {
          "queryReplacement": "={{ [$('Keep Input Data').item.json.request_id] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [-360, 240],
      "id": "update-status-orchestrating",
      "name": "Update Status: ORCHESTRATING",
      "credentials": {
        "postgres": {
          "id": "TxOzBdadKcgasYEn",
          "name": "MAESTRO DB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const analysis = $('Fetch Analysis from DB').first().json;\nconst inputData = $('Keep Input Data').first().json;\n\nconsole.log('=== ORCHESTRATOR v2 STARTED ===');\nconsole.log('Analysis:', JSON.stringify(analysis, null, 2));\n\nlet agentsNeeded = [];\ntry {\n  agentsNeeded = typeof analysis.agents_needed === 'string' ? JSON.parse(analysis.agents_needed) : (analysis.agents_needed || []);\n} catch(e) {\n  console.error('Error parsing agents_needed:', e);\n  agentsNeeded = [];\n}\n\nif (agentsNeeded.includes('CADRAGE')) {\n  console.warn('Filtering out CADRAGE');\n  agentsNeeded = agentsNeeded.filter(a => a !== 'CADRAGE');\n}\n\nconst requestText = analysis.request_text || '';\n\nconst orchestrationPlan = {\n  analysis_id: inputData.analysis_id,\n  request_id: inputData.request_id,\n  project_id: inputData.project_id,\n  original_request: requestText,\n  complexity: analysis.complexity || 'M',\n  priority: analysis.priority || 'MEDIUM',\n  agents_needed: agentsNeeded,\n  parallel_possible: Boolean(analysis.parallel_possible),\n  needs_us: agentsNeeded.includes('US'),\n  needs_dev: agentsNeeded.includes('DEV'),\n  needs_test: agentsNeeded.includes('TEST'),\n  needs_deploy: agentsNeeded.includes('DEPLOY'),\n  us_id: null,\n  dev_id: null,\n  timestamp: new Date().toISOString()\n};\n\nconsole.log('Plan created:', orchestrationPlan);\n\nreturn [{ json: orchestrationPlan }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-160, 240],
      "id": "prepare-orchestration",
      "name": "Prepare Orchestration Plan"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needs_us }}",
              "value2": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [40, 240],
      "id": "need-us",
      "name": "Need US?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://n8n:5678/webhook/user-stories",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"analysis_id\": $json.analysis_id,\n  \"request_id\": $json.request_id,\n  \"project_id\": $json.project_id,\n  \"request_text\": $json.original_request,\n  \"complexity\": $json.complexity\n} }}",
        "options": {
          "timeout": 120000,
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "autodetect"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [240, 140],
      "id": "call-us-agent",
      "name": "Call US Agent"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "field1",
              "name": "message",
              "value": "No US generation needed",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [240, 340],
      "id": "skip-us",
      "name": "Skip US"
    },
    {
      "parameters": {
        "jsCode": "const plan = $('Prepare Orchestration Plan').first().json;\nlet updatedPlan = { ...plan };\n\nif ($('Call US Agent').all().length > 0) {\n  const usResponse = $('Call US Agent').first().json;\n  if (usResponse && usResponse.status === 'success') {\n    updatedPlan.us_count = usResponse.total_stories || 0;\n    console.log('✅ US completed, stories created:', updatedPlan.us_count);\n  } else {\n    console.error('❌ US failed');\n    updatedPlan.us_count = 0;\n    updatedPlan.us_error = true;\n  }\n} else {\n  console.log('⏭️ US skipped');\n}\n\nreturn [{ json: updatedPlan }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 240],
      "id": "update-plan-after-us",
      "name": "Update Plan After US"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needs_dev }}",
              "value2": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [640, 240],
      "id": "need-dev",
      "name": "Need DEV?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "field1",
              "name": "agent",
              "value": "DEV",
              "type": "string"
            },
            {
              "id": "field2",
              "name": "status",
              "value": "placeholder",
              "type": "string"
            },
            {
              "id": "field3",
              "name": "message",
              "value": "Agent DEV pas encore implémenté",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [840, 140],
      "id": "call-dev-placeholder",
      "name": "DEV Agent (TODO)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "field1",
              "name": "message",
              "value": "No DEV needed",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [840, 340],
      "id": "skip-dev",
      "name": "Skip DEV"
    },
    {
      "parameters": {
        "jsCode": "const plan = $('Update Plan After US').first().json;\nlet updatedPlan = { ...plan };\n\nif ($('DEV Agent (TODO)').all().length > 0) {\n  console.log('⏳ DEV placeholder executed');\n} else {\n  console.log('⏭️ DEV skipped');\n}\n\nreturn [{ json: updatedPlan }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1040, 240],
      "id": "update-plan-after-dev",
      "name": "Update Plan After DEV"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needs_test }}",
              "value2": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1240, 240],
      "id": "need-test",
      "name": "Need TEST?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "field1",
              "name": "agent",
              "value": "TEST",
              "type": "string"
            },
            {
              "id": "field2",
              "name": "status",
              "value": "placeholder",
              "type": "string"
            },
            {
              "id": "field3",
              "name": "message",
              "value": "Agent TEST pas encore implémenté",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1440, 140],
      "id": "call-test-placeholder",
      "name": "TEST Agent (TODO)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "field1",
              "name": "message",
              "value": "No TEST needed",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1440, 340],
      "id": "skip-test",
      "name": "Skip TEST"
    },
    {
      "parameters": {
        "jsCode": "const orchestrationPlan = $('Update Plan After DEV').first().json;\n\nconst results = {\n  request_id: orchestrationPlan.request_id,\n  analysis_id: orchestrationPlan.analysis_id,\n  project_id: orchestrationPlan.project_id,\n  timestamp: new Date().toISOString(),\n  complexity: orchestrationPlan.complexity,\n  agents_executed: [],\n  us_count: orchestrationPlan.us_count || 0,\n  errors: []\n};\n\nif ($('Call US Agent').all().length > 0) {\n  if (orchestrationPlan.us_error) {\n    results.errors.push('US generation failed');\n  } else {\n    results.agents_executed.push('US');\n  }\n}\n\nif ($('DEV Agent (TODO)').all().length > 0) {\n  results.agents_executed.push('DEV (placeholder)');\n}\n\nif ($('TEST Agent (TODO)').all().length > 0) {\n  results.agents_executed.push('TEST (placeholder)');\n}\n\nresults.orchestration_status = results.errors.length > 0 ? 'COMPLETED_WITH_ERRORS' : 'COMPLETED';\nresults.summary = `Orchestration complétée avec ${results.agents_executed.length} agent(s): ${results.agents_executed.join(' → ')}`;\n\nif (results.us_count > 0) {\n  results.summary += ` | ${results.us_count} User Stories créées`;\n}\n\nif (results.errors.length > 0) {\n  results.summary += ` | Erreurs: ${results.errors.join(', ')}`;\n}\n\nconsole.log('=== ORCHESTRATION COMPLETE ===');\nconsole.log('Agents executed:', results.agents_executed.join(' → '));\nconsole.log('User Stories:', results.us_count);\n\nreturn [{ json: results }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1640, 240],
      "id": "compile-results",
      "name": "Compile Results"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE maestro.requests SET status = 'AGENTS_RUNNING', updated_at = NOW() WHERE id = $1::uuid",
        "options": {
          "queryReplacement": "={{ [$('Compile Results').item.json.request_id] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1840, 240],
      "id": "update-status-running",
      "name": "Update Status: RUNNING",
      "credentials": {
        "postgres": {
          "id": "TxOzBdadKcgasYEn",
          "name": "MAESTRO DB"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($('Compile Results').item.json, null, 2) }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [2040, 240],
      "id": "respond-webhook",
      "name": "Respond to Webhook"
    }
  ],
  "connections": {
    "Start Orchestration": {
      "main": [[{"node": "Keep Input Data", "type": "main", "index": 0}]]
    },
    "Keep Input Data": {
      "main": [[{"node": "Fetch Analysis from DB", "type": "main", "index": 0}]]
    },
    "Fetch Analysis from DB": {
      "main": [[{"node": "Update Status: ORCHESTRATING", "type": "main", "index": 0}]]
    },
    "Update Status: ORCHESTRATING": {
      "main": [[{"node": "Prepare Orchestration Plan", "type": "main", "index": 0}]]
    },
    "Prepare Orchestration Plan": {
      "main": [[{"node": "Need US?", "type": "main", "index": 0}]]
    },
    "Need US?": {
      "main": [
        [{"node": "Call US Agent", "type": "main", "index": 0}],
        [{"node": "Skip US", "type": "main", "index": 0}]
      ]
    },
    "Call US Agent": {
      "main": [[{"node": "Update Plan After US", "type": "main", "index": 0}]]
    },
    "Skip US": {
      "main": [[{"node": "Update Plan After US", "type": "main", "index": 0}]]
    },
    "Update Plan After US": {
      "main": [[{"node": "Need DEV?", "type": "main", "index": 0}]]
    },
    "Need DEV?": {
      "main": [
        [{"node": "DEV Agent (TODO)", "type": "main", "index": 0}],
        [{"node": "Skip DEV", "type": "main", "index": 0}]
      ]
    },
    "DEV Agent (TODO)": {
      "main": [[{"node": "Update Plan After DEV", "type": "main", "index": 0}]]
    },
    "Skip DEV": {
      "main": [[{"node": "Update Plan After DEV", "type": "main", "index": 0}]]
    },
    "Update Plan After DEV": {
      "main": [[{"node": "Need TEST?", "type": "main", "index": 0}]]
    },
    "Need TEST?": {
      "main": [
        [{"node": "TEST Agent (TODO)", "type": "main", "index": 0}],
        [{"node": "Skip TEST", "type": "main", "index": 0}]
      ]
    },
    "TEST Agent (TODO)": {
      "main": [[{"node": "Compile Results", "type": "main", "index": 0}]]
    },
    "Skip TEST": {
      "main": [[{"node": "Compile Results", "type": "main", "index": 0}]]
    },
    "Compile Results": {
      "main": [[{"node": "Update Status: RUNNING", "type": "main", "index": 0}]]
    },
    "Update Status: RUNNING": {
      "main": [[{"node": "Respond to Webhook", "type": "main", "index": 0}]]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "ed02db89d7f2488035bfec7b1491988dab1d203f160701f703954ad6afe22be8"
  }
}
