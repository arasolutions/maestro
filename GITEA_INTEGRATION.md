# Gitea Integration pour MAESTRO

## 1. Configuration Initiale

### 1.1 G√©n√©rer un Token API Gitea

1. Connectez-vous √† Gitea: https://git.maestro.ara-solutions.cloud
2. Allez dans **Settings** (Param√®tres) ‚Üí **Applications**
3. Section "Manage Access Tokens" ‚Üí **Generate New Token**
4. Configuration du token:
   - **Token Name**: `maestro-api`
   - **Permissions** (s√©lectionnez):
     - ‚úì `repo` (Full control of repositories)
     - ‚úì `admin:org` (Full control of orgs)
     - ‚úì `write:repository` (Write access to code)
     - ‚úì `admin:repo_hook` (Full control of repository hooks)
5. Cliquez sur **Generate Token**
6. **IMPORTANT**: Copiez le token imm√©diatement (il ne sera plus affich√©)

### 1.2 Configurer le Token dans MAESTRO

Ajoutez le token dans votre fichier `.env.local`:

```bash
GITEA_API_TOKEN="votre-token-ici"
```

Ou dans Docker Compose (pour production):

```yaml
environment:
  GITEA_API_TOKEN: 'votre-token-ici'
```

### 1.3 Cr√©er l'Organisation Gitea

1. Dans Gitea, cliquez sur le **+** en haut √† droite
2. S√©lectionnez **New Organization**
3. Nom de l'organisation: `maestro`
4. Visibilit√©: **Private**
5. Cr√©ez l'organisation

## 2. Utilisation avec les Projets

### 2.1 Initialiser un D√©p√¥t Gitea pour un Projet

1. Allez dans **Projets** ‚Üí S√©lectionnez un projet
2. Cliquez sur **√âditer**
3. Section **D√©p√¥t Gitea**:
   - Si non initialis√©: Cliquez sur **üöÄ Initialiser le D√©p√¥t Gitea**
   - Si d√©j√† initialis√©: Le lien vers le d√©p√¥t Gitea est affich√©

### 2.2 Ce qui est Cr√©√© Automatiquement

Lors de l'initialisation, MAESTRO cr√©e:

1. **D√©p√¥t Gitea priv√©** dans l'organisation `maestro`
   - Nom: slug du projet (ex: `maestro-platform`)
   - Branche par d√©faut: `main`
   - `.gitignore` Symfony
   - Licence MIT

2. **README.md initial** contenant:
   - Nom et description du projet
   - Stack technique
   - Workflow MAESTRO (PM ‚Üí Cadrage ‚Üí US ‚Üí DEV ‚Üí TEST ‚Üí DEPLOY)
   - Conventions de branches

3. **Webhook vers n8n**:
   - √âv√©nements: `push`, `pull_request`, `create`, `delete`
   - URL: `https://n8n.maestro.ara-solutions.cloud/webhook/gitea`
   - Secret g√©n√©r√© automatiquement

4. **M√©tadonn√©es dans la base de donn√©es**:
   - `gitea_repo_id`: ID du d√©p√¥t Gitea
   - `gitea_repo_name`: Nom du d√©p√¥t
   - `gitea_repo_url`: URL du d√©p√¥t
   - `gitea_webhook_secret`: Secret du webhook

## 3. Workflow CI/CD avec Gitea

### 3.1 Flux Automatique

```
User Story cr√©√©e
    ‚Üì
Agent DEV g√©n√®re le code
    ‚Üì
Code committ√© dans Gitea (branche feature/US-XXX)
    ‚Üì
Pull Request cr√©√©e automatiquement
    ‚Üì
Webhook ‚Üí n8n ‚Üí Agent TEST
    ‚Üì
Tests ex√©cut√©s (PHPUnit, Playwright)
    ‚Üì
Si tests OK: Merge automatique
    ‚Üì
Webhook ‚Üí n8n ‚Üí Agent DEPLOY
    ‚Üì
D√©ploiement sur Coolify
```

### 3.2 Convention de Branches

- **`main`**: Branche de production
- **`feature/US-{id}-{description}`**: Fonctionnalit√©s
  - Ex: `feature/US-001-authentication`
- **`hotfix/{description}`**: Corrections urgentes
  - Ex: `hotfix/fix-login-bug`

### 3.3 Commits et Pull Requests

Les commits g√©n√©r√©s par MAESTRO suivent le format:

```
feat(us-001): Add user authentication

- Implement login form
- Add JWT token generation
- Create user session management

Generated by Agent DEV
Related US: US-001
```

## 4. API Gitea - Endpoints Disponibles

Le service `GiteaService` expose les m√©thodes suivantes:

### 4.1 Repositories

```php
// Cr√©er un d√©p√¥t
$giteaService->createRepository(
    projectName: 'mon-projet',
    description: 'Description du projet'
);

// R√©cup√©rer les infos d'un d√©p√¥t
$giteaService->getRepository('mon-projet');
```

### 4.2 Branches

```php
// Cr√©er une branche
$giteaService->createBranch(
    repoName: 'mon-projet',
    branchName: 'feature/US-001',
    fromBranch: 'main'
);
```

### 4.3 Fichiers

```php
// Cr√©er ou mettre √† jour un fichier
$giteaService->createOrUpdateFile(
    repoName: 'mon-projet',
    filePath: 'src/Controller/UserController.php',
    content: $code,
    message: 'feat: Add user controller',
    branch: 'feature/US-001'
);
```

### 4.4 Pull Requests

```php
// Cr√©er une PR
$giteaService->createPullRequest(
    repoName: 'mon-projet',
    title: 'feat: Add user authentication',
    description: 'Implementation of US-001',
    headBranch: 'feature/US-001',
    baseBranch: 'main'
);

// Merger une PR
$giteaService->mergePullRequest(
    repoName: 'mon-projet',
    prNumber: 1
);

// Ajouter un commentaire
$giteaService->addPullRequestComment(
    repoName: 'mon-projet',
    prNumber: 1,
    comment: 'Tests passed ‚úì'
);
```

### 4.5 Webhooks

```php
// Cr√©er un webhook
$giteaService->createWebhook(
    repoName: 'mon-projet',
    webhookUrl: 'https://n8n.maestro.ara-solutions.cloud/webhook/gitea',
    secret: 'webhook-secret'
);
```

## 5. S√©curit√©

### 5.1 Tokens et Secrets

- **API Token**: Stock√© dans `.env.local`, jamais committ√©
- **Webhook Secrets**: G√©n√©r√©s automatiquement (32 caract√®res)
- **D√©p√¥ts**: Tous priv√©s par d√©faut

### 5.2 V√©rification des Webhooks

Les webhooks de Gitea incluent un header `X-Gitea-Signature` pour v√©rifier l'authenticit√©:

```php
$signature = $request->headers->get('X-Gitea-Signature');
$payload = $request->getContent();
$secret = $project['gitea_webhook_secret'];

$expectedSignature = hash_hmac('sha256', $payload, $secret);

if (!hash_equals($expectedSignature, $signature)) {
    throw new AccessDeniedException('Invalid webhook signature');
}
```

## 6. Monitoring et Logs

### 6.1 V√©rifier la Connexion Gitea

Endpoint de test:

```bash
curl http://localhost:8080/admin/gitea/test
```

Retour attendu:

```json
{
  "success": true,
  "message": "Connexion r√©ussie √† Gitea",
  "user": "maestro_admin"
}
```

### 6.2 Logs

Les op√©rations Gitea sont logu√©es dans:

```
symfony-app/var/log/dev.log
```

Recherche des logs Gitea:

```bash
grep "Gitea" symfony-app/var/log/dev.log
```

## 7. Troubleshooting

### Erreur: "Failed to create Gitea repository"

**Causes possibles**:
- Token API invalide ou expir√©
- Organisation `maestro` n'existe pas
- D√©p√¥t avec le m√™me nom existe d√©j√†

**Solution**:
1. V√©rifier le token dans `.env.local`
2. V√©rifier que l'organisation `maestro` existe dans Gitea
3. V√©rifier les logs: `var/log/dev.log`

### Erreur: "Webhook creation failed"

**Causes possibles**:
- URL du webhook inaccessible depuis Gitea
- Network Docker mal configur√©

**Solution**:
1. V√©rifier que n8n est accessible depuis le container Gitea:
   ```bash
   docker exec maestro-gitea curl http://n8n:5678/healthz
   ```
2. V√©rifier que les deux containers sont sur le r√©seau `coolify`

### Erreur: "Repository already exists"

Si un d√©p√¥t existe d√©j√† pour un projet:

1. Option 1: Supprimer le d√©p√¥t dans Gitea manuellement
2. Option 2: Mettre √† jour manuellement la table `projects`:
   ```sql
   UPDATE maestro.projects
   SET gitea_repo_id = NULL,
       gitea_repo_name = NULL,
       gitea_repo_url = NULL
   WHERE slug = 'mon-projet';
   ```

## 8. Roadmap

### Fonctionnalit√©s Futures

- [ ] Clone de d√©p√¥ts existants
- [ ] Import de projets depuis GitHub/GitLab
- [ ] Gestion des tags et releases
- [ ] Int√©gration avec SonarQube pour l'analyse de code
- [ ] Backup automatique des d√©p√¥ts
- [ ] Statistiques Git (commits, contributors, etc.)

---

**Documentation g√©n√©r√©e pour MAESTRO v1.0**
